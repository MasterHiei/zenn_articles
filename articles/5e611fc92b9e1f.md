---
title: "dioã§ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’ä½œã‚‹"
emoji: "ğŸ‘»"
type: "tech"
topics: ["Flutter", "dio", "APIé€šä¿¡", "ãƒªãƒˆãƒ©ã‚¤"]
publication_name: "minma"
published: true
---
# ã¯ã˜ã‚ã«

`dio`ã¨ã¯ã€[pub.dev](https://pub.dev)ã§LIKES 6000ã‚’è¶…ãˆã‚‹è¶…äººæ°—ã®APIé€šä¿¡ã‚’è¡Œã†ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚

https://pub.dev/packages/dio


APIé€šä¿¡ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã€ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’æ›¸ããŸã„ã‚±ãƒ¼ã‚¹ã¯çã—ããªã„ã§ã™ã­ã€‚

ãã®å ´åˆã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¢ã—ã¦åˆ©ç”¨ã™ã‚‹ã®ã¯å‹¿è«–ã€ç´°ã‹ã„ã¨ã“ã‚ã¾ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„ãŒã€å¤–éƒ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã ã¨ã‚„ã‚Šã¥ã‚‰ã„ã¨æ„Ÿã˜ã¦è‡ªå‰ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚å…¨ç„¶ã‚ã‚Šã‹ã¨æ€ã„ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€`Interceptor`ã‚’ä½¿ã£ãŸãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# åˆ©ç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

`2024/1/17`ç¾åœ¨æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```dart:pubspec.yaml
dependencies:
  dio: ^5.4.0
```

# å®Ÿè£…æ–¹æ³•

```dart
void main() {
  final dio = Dio();
  dio.interceptors.add(RetryInterceptor(dio));

  // APIé€šä¿¡ã‚’è¡Œã†
  dio.get('https://api.example.com');
}

class RetryInterceptor extends Interceptor {
  RetryInterceptor(this.dio);

  final Dio dio;

  static const _retries = 3;
  static const _retryInterval = Duration(seconds: 1);
  static const _extraKey = 'dio_retries';

  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    // ã“ã“ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹å‰ã«ä½•ã‹ã®å‡¦ç†ã‚’è¡Œã†
    // ä¾‹ï¼šã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã¨å†å–å¾—
    super.onRequest(options, handler);
  }

  @override
  Future<void> onError(
    DioException err,
    ErrorInterceptorHandler handler,
  ) async {
    final statusCode = err.response?.statusCode;
    final isUnauthorized = statusCode == HttpStatus.unauthorized;

    // èªè¨¼ã‚¨ãƒ©ãƒ¼
    if (isUnauthorized) {
      await _retry(err, handler);
      return;
    }

    return super.onError(err, handler);
  }

  Future<void> _retry(
    DioException err,
    ErrorInterceptorHandler handler,
  ) async {
    final extra = err.requestOptions.extra;
    final retries = err.requestOptions.retries;
    if (retries <= 0) {
      // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™å›æ•°ã«é”ã—ãŸã®ã§ã€ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
      return super.onError(err, handler);
    }

    // ãƒªãƒˆãƒ©ã‚¤é–“éš”ã‚’å…¥ã‚Œã‚‹
    await Future<void>.delayed(_retryInterval);

    try {
      // å†åº¦APIã‚’å‘¼ã³å‡ºã™ãªã©ã€ã‚„ã‚ŠãŸã„ã“ã¨ã‚’ã‚„ã‚‹
      final response = await dio.fetch<dynamic>(err.requestOptions);
      // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
      extra.remove(_extraKey);
      return handler.resolve(response);
    } catch (_) {
      // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’1ãšã¤æ¸›ã‚‰ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¨­å®šã™ã‚‹
      err.requestOptions.extra = extra..addAll({_extraKey: retries - 1});
      // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’å†å¸°çš„ã«å®Ÿè¡Œã™ã‚‹
      _retry(err, handler);
    }
  }
}

extension _RequestOptionsHelper on RequestOptions {
  /// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’å–å¾—ã™ã‚‹
  int get retries {
    final retryExtra = extra[RetryInterceptor._extraKey];
    if (retryExtra is int) {
      return retryExtra;
    }
    return RetryInterceptor._retries;
  }
}
```

# ã•ã„ã”ã«

`Interceptor`ã‚’ç¶™æ‰¿ã—ã¦ç‹¬è‡ªã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚„èªè¨¼å‡¦ç†ãªã©ã§ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½ãªã®ã§ã€å€‹äººé–‹ç™ºã¯ã‚‚ã¡ã‚ã‚“ã€æ™®æ®µã®æ¥­å‹™ã«ã‚‚ã”æ´»ç”¨ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚
