---
title: "Flutter Windowsã§WebViewã‚’ä½¿ã†æ–¹æ³•â‘¡"
emoji: "ğŸ‘Œ"
type: "tech"
topics: ["Flutter", "Windows", "webview"]
publication_name: "minma"
published: true
---
# ã¯ã˜ã‚ã«

[å‰å›](https://zenn.dev/chenxi/articles/1cea5054f19db8)ã®ç¶šãã¨ã—ã¦ã€[webview_windows](https://pub.dev/packages/webview_windows)ã‚’ä½¿ã£ã¦JavaScriptã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã€ã¾ãŸã¯ãã®çµæœã‚’å—ã‘å–ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚’æ›¸ã“ã†ã¨æ€ã„ã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨

ã‚„ã‚‹å‰ã«ã€ã¾ãšã¯ä»•æ§˜ã‚’æ•´ç†ã—ã¾ã™ã€‚

- Flutterã§ä½•ã‹ã®JavaScriptå‡¦ç†ã‚’å®Ÿè¡Œã—ã€ãã®çµæœã‚’WebViewã«åæ˜ 

- WebViewã‹ã‚‰ä½•ã‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’Flutterã«é€ä¿¡ã—ã€ãã®çµæœã‚’Flutterã§è¡¨ç¤º

ç°¡å˜ãªã“ã¨ã§ã™ã­ã€ã•ã£ããå§‹ã‚ã¾ã—ã‚‡ã†ã€‚

# å®Ÿè£…

## Flutterã§JavaScriptã‚’ä½¿ã†

`WebviewController.executeScript`ã¨ã„ã†APIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€JavaScriptã®å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚

```dart
  Future<void> _initWebView() async {
    // å‰å›ã®å®Ÿè£…
    if (context.mounted) {
      setState(() {});
    }

    // WebViewã‚’è¡¨ç¤ºã—ã¦1ç§’å¾Œã€Zenn Topicã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€ŒJavaScript Method Testã€ã«å¤‰ãˆã‚‹
    Future.delayed(
      const Duration(seconds: 1),
      () => _webviewController.executeScript(
        '''
        var elems = document.getElementsByClassName("TopicHeader_title__INUvl");
        elems[0].innerHTML = "JavaScript Method Test";
        ''',
      ),
    );
  }
```

æˆæœç‰©â‘ 

![ed1](https://storage.googleapis.com/zenn-user-upload/6092b090cac7-20230925.png)

## JavaScriptã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’Flutterã«æ¸¡ã™

ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™å‡¦ç†ã§ã™ã­ã€‚

```dart
  Future<void> _initWebView() async {
    // å‰å›ã®å®Ÿè£…
    if (context.mounted) {
      setState(() {});
    }

    // postMessageã‚’ä½¿ã£ã¦HTMLæ–‡å­—åˆ—ã‚’é€ã‚‹
    Future.delayed(
      const Duration(seconds: 1),
      () => _webviewController.executeScript(
        '''
        var elems = document.getElementsByClassName("TopicHeader_title__INUvl");
        window.chrome.webview.postMessage(elems[0].outerHTML);
        ''',
      ),
    );
  }
```

ãã—ã¦ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹å‡¦ç†ã§ã™ã€‚

```dart
  Future<void> _initWebView() async {
    // å‰å›ã®å®Ÿè£…
    if (context.mounted) {
      setState(() {});
    }

    // å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§è¡¨ç¤ºã™ã‚‹
    _webviewController.webMessage.listen(
      (dynamic event) => showDialog<void>(
        context: context,
        builder: (_) => AlertDialog(
          title: Text('$event'),
        ),
      ),
    );
  }
```

æˆæœç‰©â‘¡

![ed2](https://storage.googleapis.com/zenn-user-upload/6dc2a7252e0f-20230927.png)

ã‚‚ã¡ã‚ã‚“ã€è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ°—ã«é€ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```dart
  Future<void> _initWebView() async {
    // å‰å›ã®å®Ÿè£…
    if (context.mounted) {
      setState(() {});
    }

    // JSONå½¢å¼ã§outerHTMLã¨innerHTMLã‚’åŒæ™‚ã«æ¸¡ã™
    Future.delayed(
      const Duration(seconds: 2),
      () => _webviewController.executeScript(
        '''
        var elems = document.getElementsByClassName("TopicHeader_title__INUvl");
        var outerHTML = JSON.stringify(elems[0].outerHTML);
        var innerHTML = JSON.stringify(elems[0].innerHTML);
        var jsonString = `{"outerHTML": \${outerHTML}, "innerHTML": \${innerHTML}}`;
        window.chrome.webview.postMessage(JSON.parse(jsonString));
        ''',
      ),
    );

    _webviewController.webMessage.listen((dynamic event) {
      if (event is! Map) {
        return;
      }

      // Keyâ€“valueãªã®ã§ã€ä»•æ§˜ã«åˆã‚ã›ã¦ãŠå¥½ããªå½¢ã«ã§ãã‚‹
      final children = <Widget>[];
      for (var entry in event.entries) {
        children.add(
          ListTile(
            title: Text(entry.key),
            subtitle: Text(entry.value),
          ),
        );
      }
      showDialog<void>(
        context: context,
        builder: (_) => AlertDialog(
          title: Column(children: children),
        ),
      );
    });
  }
```

æˆæœç‰©â‘¢

![ed3](https://storage.googleapis.com/zenn-user-upload/42cd5ceae484-20230927.png)

# ã•ã„ã”ã«

ä»Šå›ã¯ã€[webview_windows](https://pub.dev/packages/webview_windows)ã§JavaScriptã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã“ã®ã‚ˆã†ã«æ›¸ã‘ã°ã€å¿…è¦æœ€ä½é™ã®å®Ÿè£…ã¯ã§ãã‚‹ã‹ãªã¨æ€ã„ã¾ã™ã€‚

ä»–ã«ã‚‚æ§˜ã€…ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒã‚ã‚‹ã®ã§ã™ãŒã€ã”å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
